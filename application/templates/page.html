{%extends 'part/base'%}
{%block title%}
<title>{{post.title}}</title>
<meta name="keywords" content="{%for tag in post.tags%}{{tag}} {%endfor%}">
{%endblock title%}
{%block main%}
<div id="main">
	<div class="spacecontent20"></div>
	<input type="hidden" id="post_id" value="{{post.post_id}}">
	<div id="page" class="post">
		<div class="spacecontent20"></div>
		<div id="title"><h3><a href="/post/{{post.post_id}}">{{post.title}}</a></h3></div>
		<div id="time"><span class="smalltime">{{post.create_date}}</span></div>
		<div class="pageline"></div>
		<div id="pagecontent">
			<div id="pagebody">
				{{post.content|safe}}
			</div>
			<div id="pagefoot">
				<div class="pageline"></div>
				<div class="spacecontent20"></div>
                <div class="tagcloud">
                {%for tag in post.tags%}
                    <a class="tagitem" href="/tag/{{tag}}">{{tag}}</a>
                {%endfor%}
                 </div><div class="clear spacecontent20"></div>
                Operation:&nbsp;<a href="/admin/post/{{post.post_id}}">编辑</a>,<a class="gotocomment">回复</a>
				<div class="spacecontent20"></div>
			</div>
		</div>
	</div>
    {%if comments%}
    <div id="comment" class="post">
        <h4>COMMENTS</h4>
        {%for comment in comments%}
            <div class="onecomment">
                <p><strong>{{comment.nickname}}</strong> 在 <span class="smalltime">{{comment.create_date}}</span>:</p>
                {{comment.comment}}  
            </div>
        {%endfor%}
    {%endif%}



    </div>
</div>
<div class="spacecontent40"></div>
{%endblock main%}

{%block script%}
	<link href="/static/css/syntaxhighlighter/shCore.css"  rel="stylesheet" type="text/css"/>
	<link href="/static/css/syntaxhighlighter/shThemeRDark.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/lightbox.css">
	<script type="text/javascript" src="/static/js/syntaxhighlighter/shCore.js"></script>
	<script type="text/javascript" src="/static/js/syntaxhighlighter/shAutoloader.js"></script>
    <script type="text/javascript" src="/static/js/jquery.autoIMG.js"></script>
    <script type="text/javascript" src="/static/js/lightbox.js"></script>
    <script type="text/javascript" src="/static/js/tinymce/tiny_mce.js"></script>

<script type="text/javascript">

function path()
{
    var args = arguments,
    result = [];
    for(var i = 0; i < args.length; i++)
        result.push(args[i].replace('@', '/static/js/syntaxhighlighter/'));
    return result
};
$(document).ready(function(){
	//SyntaxHighlighter.vars.discoveredBrushes=null;
	SyntaxHighlighter.autoloader.apply(null, path(
    'applescript            @shBrushAppleScript.js',
    'actionscript3 as3      @shBrushAS3.js',
    'bash shell             @shBrushBash.js',
    'coldfusion cf          @shBrushColdFusion.js',
    'cpp c                  @shBrushCpp.js',
    'c# c-sharp csharp      @shBrushCSharp.js',
    'css                    @shBrushCss.js',
    'delphi pascal          @shBrushDelphi.js',
    'diff patch pas         @shBrushDiff.js',
    'erl erlang             @shBrushErlang.js',
    'groovy                 @shBrushGroovy.js',
    'java                   @shBrushJava.js',
    'jfx javafx             @shBrushJavaFX.js',
    'js jscript javascript  @shBrushJScript.js',
    'perl pl                @shBrushPerl.js',
    'php                    @shBrushPhp.js',
    'text plain             @shBrushPlain.js',
    'py python              @shBrushPython.js',
    'ruby rails ror rb      @shBrushRuby.js',
    'sass scss              @shBrushSass.js',
    'scala                  @shBrushScala.js',
    'sql                    @shBrushSql.js',
    'vb vbnet               @shBrushVb.js',
    'xml xhtml xslt html    @shBrushXml.js'
    ));
	$('.smalltime').each(function(){
		$(this).text(dateToString($(this).text(),"yyyy-MM-dd hh:mm"));
	});
	SyntaxHighlighter.all();
	$('a[href*=#]').click(function() {
    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') 
        && location.hostname == this.hostname) {
            var $target = $(this.hash);
            $target = $target.length && $target || $('[name=' + this.hash.slice(1) +']');
            if ($target.length) {
                var targetOffset = $target.offset().top;
                $('html,body').animate({scrollTop: targetOffset-36}, 1000);
                return false;
            }
        }
    });
    //add comment
    $(".gotocomment").each(function(){
        $(this).click(function(){
            if($('#makecomment').length==0){
                var makecomment=$('<div id="makecomment" class="post"></div>');
                var title=$('<h4>LEAVE A COMMENT</h4>')
                var button=$('<input type="button" id="commentbutton" style="width:40px;height:30px;padding:0;margin:0;" class="darkbutton" value="GO">')
                var textfield=$('<textarea id="commenttextarea" rows="4" style="width:100%; background:#000000; border:0;border-radius:3px;color:#999999"></textarea>');
                makecomment.append(title);
                makecomment.append(button);
                makecomment.append($('<br><br>'));
                makecomment.append(textfield);
                $('#main').append(makecomment);
                //bind functions
                $('#commentbutton').click(function(){
                    alert($('#commenttextarea').val());
                    var url="/comment/"+$('#post_id').val();
                    $.ajax({
                        cache:true,
                        type:"POST",
                        url:url,
                        data:$('#commenttextarea').val(),
                        contentType:"text/plain",
                        async:true,
                        error:function(){
                            alert("connection error");
                        },
                        success:function(data){
                            var result=JSON.parse(data);
                            if (result.status==0){
                                alert(result.message);
                            }
                            else{
                                freshComment();
                            }
                        }
                    });
                });
            }
        return false;
        });
    });
    //get comment
    function getcomment(){
        

    }
    //fresh comment
    function freshComment(){
        $('#comment').empty();
        var h4=$('<h4>COMMENTS</h4>');
        $('#comment').append(h4);
        var url="/comment/get/"+$('#post_id').val();
        $.ajax({
            async:true,
            url:url,
            success:function(data){
                alert(data);
                result=JSON.parse(data);
                for(var i=0;i<result.length;i++){
                    var tmp="<div class='onecomment'><p><strong>";
                    tmp+=result[i].nickname+"</strong>"+" 在 ";
                    tmp+="<span class=smalltime>"+dateToString(result[i].create_date,"yyyy-MM-dd hh:mm")+'</span>:</p>';
                    tmp+=result[i].comment+"</div>";
                    $('#comment').append(tmp);
                }

            },
            error:function(){
                alert('connection error');
                

            }
        });

    }


    //add lightbox
    $('#page img').each(function (i){
        var strA ="<a rel='lightbox[roadtrip]' href='" + this.src + "'></a>";
        $(this).wrapAll(strA);
    });
    //resize image
    $('#pagecontent').autoIMG();
});

</script>
{%endblock script%}
